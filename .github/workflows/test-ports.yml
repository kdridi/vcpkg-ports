name: Test vcpkg ports

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - runner: ubuntu-latest
            triplet: x64-linux
          # macOS x64
          - runner: macos-15
            triplet: x64-osx
          # macOS ARM64
          - runner: macos-14
            triplet: arm64-osx
          # Windows
          - runner: windows-latest
            triplet: x64-windows

    runs-on: ${{ matrix.runner }}

    steps:
    - name: Checkout vcpkg-ports
      uses: actions/checkout@v4
      with:
        path: vcpkg-ports

    - name: Checkout vcpkg
      uses: actions/checkout@v4
      with:
        repository: microsoft/vcpkg
        path: vcpkg

    - name: Bootstrap vcpkg
      working-directory: vcpkg
      run: ./bootstrap-vcpkg.sh
      shell: bash

    - name: Test fesapi port (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        export VCPKG_OVERLAY_PORTS="${GITHUB_WORKSPACE}/vcpkg-ports"
        "${GITHUB_WORKSPACE}/vcpkg/vcpkg" install fesapi --triplet=${{ matrix.triplet }} --overlay-ports="${VCPKG_OVERLAY_PORTS}"
      shell: bash

    - name: Test fesapi port (Windows)
      if: runner.os == 'Windows'
      run: |
        $env:VCPKG_OVERLAY_PORTS = "$env:GITHUB_WORKSPACE\vcpkg-ports"
        & "$env:GITHUB_WORKSPACE\vcpkg\vcpkg.exe" install fesapi --triplet=${{ matrix.triplet }} --overlay-ports="$env:VCPKG_OVERLAY_PORTS"
      shell: pwsh

    - name: Verify installation (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        "${GITHUB_WORKSPACE}/vcpkg/vcpkg" list fesapi --triplet=${{ matrix.triplet }}
        echo "✅ fesapi installed successfully on ${{ matrix.triplet }}!"
      shell: bash

    - name: Verify installation (Windows)
      if: runner.os == 'Windows'
      run: |
        "$GITHUB_WORKSPACE/vcpkg/vcpkg.exe" list fesapi --triplet=${{ matrix.triplet }}
        echo "✅ fesapi installed successfully on ${{ matrix.triplet }}!"
      shell: pwsh

    - name: Test CMake integration (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        cd vcpkg-ports/fesapi/test
        cmake -B build -DCMAKE_TOOLCHAIN_FILE=${GITHUB_WORKSPACE}/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} -DCMAKE_BUILD_TYPE=Release
        cmake --build build
        ./build/test_app
      shell: bash

    - name: Test CMake integration (Windows)
      if: runner.os == 'Windows'
      run: |
        cd vcpkg-ports\fesapi\test
        cmake -B build -DCMAKE_TOOLCHAIN_FILE="$env:GITHUB_WORKSPACE\vcpkg\scripts\buildsystems\vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} -DCMAKE_BUILD_TYPE=Release
        cmake --build build
        .\build\test_app.exe
      shell: pwsh
